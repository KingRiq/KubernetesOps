- name: Add Nextcloud Helm repo
  command: helm repo add nextcloud https://nextcloud.github.io/helm/

- name: Update Helm repos
  command: helm repo update

- name: Copy Nextcloud values.yaml from template directory
  template:
    src: values.yml
    dest: /tmp/nextcloud-values.yaml

- name: Create namespace for Nextcloud
  command: /var/lib/rancher/rke2/bin/kubectl create namespace nextcloud
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
  ignore_errors: yes
  register: ns_create
  failed_when: ns_create.rc != 0 and 'AlreadyExists' not in ns_create.stderr

- name: Install Nextcloud via Helm
  command: >
    helm install nextcloud nextcloud/nextcloud
    --namespace nextcloud
    -f /tmp/nextcloud-values.yaml
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml


- name: Wait for Nextcloud pod to be ready
  command: /var/lib/rancher/rke2/bin/kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=nextcloud -n nextcloud --timeout=300s
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml