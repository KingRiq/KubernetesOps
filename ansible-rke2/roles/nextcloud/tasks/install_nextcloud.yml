- name: Add Nextcloud Helm repo
  command: helm repo add nextcloud https://nextcloud.github.io/helm/

- name: Update Helm repos
  command: helm repo update

- name: Copy Nextcloud values.yaml from template directory
  template:
    src: values.yml
    dest: /tmp/nextcloud-values.yaml

- name: Create namespace for Nextcloud
  command: /var/lib/rancher/rke2/bin/kubectl create namespace nextcloud
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
  ignore_errors: yes
  register: ns_create
  failed_when: ns_create.rc != 0 and 'AlreadyExists' not in ns_create.stderr

- name: Scale down Nextcloud deployment to 0 replicas
  kubernetes.core.k8s_scale:
    api_version: apps/v1
    kind: Deployment
    namespace: nextcloud
    name: nextcloud
    replicas: 0
    kubeconfig: /etc/rancher/rke2/rke2.yaml
  ignore_errors: yes

- name: Ensure old PV is absent if spec changes
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
  kubernetes.core.k8s:
    state: absent
    kind: PersistentVolume
    namespace: nextcloud
    name: nextcloud-mariadb-pv
  when: delete_volumes | default(false) | bool

- name: Ensure old PVC is absent if spec changes
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
  kubernetes.core.k8s:
    state: absent
    kind: PersistentVolumeClaim
    namespace: nextcloud
    name: nextcloud-mariadb-pvc
  when: delete_volumes | default(false) | bool

- name: Ensure local PV exists for MariaDB separately
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: nextcloud-mariadb-pv
      spec:
        capacity:
          storage: 2Ti
        accessModes:
          - ReadWriteOnce
        persistentVolumeReclaimPolicy: Retain
        storageClassName: ""
        nfs:
          server: "{{ storage_node_ip }}"
          path: "/nextcloud-mariadb"   # <- make a dedicated dir for MariaDB
          mountOptions:
            - nfsvers=4.2

- name: Ensure PVC exists for MariaDB
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: nextcloud-mariadb-pvc
        namespace: nextcloud
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 2Ti
        storageClassName: "" # bind to the static PV
        volumeName: nextcloud-mariadb-pv   # <- corrected reference

- name: Deploy Nextcloud with Helm
  command: >
    helm upgrade --install nextcloud nextcloud/nextcloud --namespace nextcloud -f /tmp/nextcloud-values.yaml
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml

- name: Wait for Nextcloud pod to be ready
  command: /var/lib/rancher/rke2/bin/kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=nextcloud -n nextcloud --timeout=300s
  environment:
    KUBECONFIG: /etc/rancher/rke2/rke2.yaml
