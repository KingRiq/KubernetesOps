# ================================
# 1. Namespace
# ================================
apiVersion: v1
kind: Namespace
metadata:
  name: storage
  labels:
    argocd.argoproj.io/instance: nfs
---
# ================================
# 2. NFS ConfigMap
# ================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: nfs-exports
  namespace: storage
  labels:
    argocd.argoproj.io/instance: nfs
data:
  exports: |
    /exports *(rw,fsid=0,async,no_subtree_check,insecure,no_root_squash,crossmnt)
---
# ================================
# 3 NFS Server Deployment
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-server
  namespace: storage
  labels:
    argocd.argoproj.io/instance: nfs
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-server
  template:
    metadata:
      labels:
        app: nfs-server
    spec:
      dnsPolicy: ClusterFirst
      nodeSelector:
        kubernetes.io/hostname: {{ storage_node }}
      containers:
        - name: nfs
          image: itsthenetwork/nfs-server-alpine:latest
          securityContext:
            privileged: true
          env:
            - name: SHARED_DIRECTORY
              value: "{{ nfs_export_path }}"
          ports:
            - containerPort: 2049
              name: nfs
              protocol: TCP
          readinessProbe:
            tcpSocket: { port: 2049 }
            initialDelaySeconds: 3
            periodSeconds: 5
          volumeMounts:
            - name: nfs-data
              mountPath: "{{ nfs_export_path }}"
              mountPropagation: HostToContainer
            - name: nfs-crystal
              mountPath: /exports/Crystal_Tokyo
              mountPropagation: HostToContainer
            # - name: nfs-silver
            #   mountPath: /exports/Silver_Millenium
            #   mountPropagation: HostToContainer
            # - name: nfs-shadow
            #   mountPath: /exports/Shadow_Galactica
            #   mountPropagation: HostToContainer
            - name: nfs-chaos
              mountPath: /exports/Chaos_Cauldron
              mountPropagation: HostToContainer
            - name: nfs-exports-config
              mountPath: /etc/exports   
              subPath: exports          
              readOnly: true
      volumes:
        - name: nfs-data
          hostPath:
            path: "{{ storage_host_path }}"
            type: DirectoryOrCreate
        - name: nfs-crystal
          hostPath:
            path: /mnt/windows/share/Crystal_Tokyo
            type: DirectoryOrCreate
#       - name: nfs-silver
#         hostPath:
#           path: /mnt/windows/share/Silver_Millenium
#           type: DirectoryOrCreate
#       - name: nfs-shadow
#         hostPath:
#           path: /mnt/windows/share/Shadow_Galactica
#           type: DirectoryOrCreate
        - name: nfs-chaos
          hostPath:
            path: /mnt/windows/share/Chaos_Cauldron
            type: DirectoryOrCreate
        - name: nfs-exports-config
          configMap:
            name: nfs-exports
---
# ================================
# 4. PersistentVolumeClaims
# ================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: artemis
  namespace: storage
  labels:
    dir: Crystal_Tokyo
    argocd.argoproj.io/instance: nfs
spec:
  accessModes: ["ReadWriteMany"]
  resources:
    requests:
      storage: 1Ti
  storageClassName: external-host
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: luna
  namespace: storage
  labels:
    dir: Silver_Millenium
    argocd.argoproj.io/instance: nfs
spec:
  accessModes: ["ReadWriteMany"]
  resources:
    requests:
      storage: 1Ti
  storageClassName: external-host
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: axion
  namespace: storage
  labels:
    dir: Shadow_Galactica
spec:
  accessModes: ["ReadWriteMany"]
  resources:
    requests:
      storage: 100Gi
  storageClassName: external-host
---
# ================================
# 5. Samba ConfigMap
# ================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: samba-config
  namespace: storage
  labels:
    argocd.argoproj.io/instance: nfs
data:
  smb.conf: |
    [global]
      server role = standalone server
      security = user
      map to guest = Bad Password
      guest account = nobody
      server min protocol = SMB2
      client min protocol = SMB2
      ntlm auth = yes
      log file = /var/log/samba/log.%m
      max log size = 1000

    [CloudData]
      path = /data/share
      browseable = yes
      read only = no
      valid users = galaxia
      guest ok = yes
      public = yes
      guest only = yes
---
# ================================
# 5. Samba PV/PVC for latest NFS
# ================================
apiVersion: v1
kind: PersistentVolume
metadata:
  name: samba-nfs-pv
spec:
  capacity:
    storage: 8Ti
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  mountOptions:
    - vers=4.1
  nfs:
    server: 192.168.0.236
    path: "/"                   # for your fsid=0-on-/exports setup
  claimRef:
    namespace: storage
    name: samba-nfs-pvc         # pre-bind to the PVC below (optional but nice)

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: samba-nfs-pvc
  namespace: storage
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 8Ti
  volumeName: samba-nfs-pv       # bind specifically to that PV
  storageClassName: ""           # important for static PVs
---
# ================================
# 5. Samba Deployment
# ================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: samba
  namespace: storage
  labels:
    argocd.argoproj.io/instance: nfs
spec:
  replicas: 1
  selector:
    matchLabels:
      app: samba
  template:
    metadata:
      labels:
        app: samba
    spec:
      dnsPolicy: ClusterFirst                            # no hostNetwork when using a Service
      containers:
        - name: samba
          image: dperson/samba:latest
          args:
            - "-u"
            - "galaxia;galaxia"
            - "-s"
            - "CloudData;/data/share;yes;no;yes;all"
          securityContext: 
            privileged: true
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh", "-c", "smbcontrol all shutdown"]
          env:
            - name: SAMBA_LOG_LEVEL
              value: "1"
          ports:
            - containerPort: 445
              name: smb
              protocol: TCP
          readinessProbe:
            tcpSocket: { port: 445 }
            initialDelaySeconds: 3
            periodSeconds: 5
          volumeMounts:
            - name: smb-conf
              mountPath: /etc/samba
            # - name: data
            #   mountPath: /data/share                
              # mountPropagation: HostToContainer
            - name: artemis-host
              mountPath: /data/share/Crystal_Tokyo            
              mountPropagation: HostToContainer
            # - name: luna-host
            #   mountPath: /data/share/Silver_Millenium        
            #   mountPropagation: HostToContainer
            # - name: mac-host
            #   mountPath: /data/share/Shadow_Galactica
            #   mountPropagation: HostToContainer
            # - name:  chaos-host
            #   mountPath: /data/share/Chaos_Cauldron
            #   mountPropagation: HostToContainer
            - name:  nfs
              mountPath: /data/share
      volumes:
        - name: smb-conf
          configMap: { name: samba-config }
        - name: artemis-host
          hostPath:
            path: /mnt/windows/share/Crystal_Tokyo
            type: DirectoryOrCreate
        - name: luna-host
          hostPath:
            path: /mnt/windows/share/Silver_Millenium
            type: DirectoryOrCreate
        - name: mac-host
          hostPath:
            path: /mnt/windows/share/Shadow_Galactica
            type: DirectoryOrCreate
        - name: nfs
          persistentVolumeClaim:
            claimName: samba-nfs-pvc

---
# ================================
# 6. Services
# ================================
apiVersion: v1
kind: Service
metadata:
  name: samba-lb
  namespace: storage
  labels:
    argocd.argoproj.io/instance: nfs
spec:
  type: LoadBalancer
  loadBalancerIP: {{ samba_assigned_ip }}
  selector:
    app: samba
  ports:
    - name: smb
      port: 445
      targetPort: 445
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: nfs-server
  namespace: storage
  labels:
    argocd.argoproj.io/instance: nfs
spec:
  type: LoadBalancer
  loadBalancerIP: {{ nfs_assigned_ip }}
  selector:
    app: nfs-server
  ports:
    - name: nfs
      port: 2049
      targetPort: 2049
      protocol: TCP
