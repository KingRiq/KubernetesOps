apiVersion: v1
kind: Namespace
metadata:
  name: {{ nextcloud_namespace }}
---
# NFS server pod (exports your external drive to the cluster)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-server
  namespace: {{ nextcloud_namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-server
  template:
    metadata:
      labels:
        app: nfs-server
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        kubernetes.io/hostname: {{ storage_node }}
      containers:
        - name: nfs
          image: itsthenetwork/nfs-server-alpine:latest
          securityContext:
            privileged: true
          env:
            - name: SHARED_DIRECTORY
              value: "/exports"
          volumeMounts:
            - name: nfs-data
              mountPath: /exports                  # THIS WILL LIVE IN THE POD it is mapped to storage_host_path
      volumes: 
        - name: nfs-data
          hostPath:
            path: "{{ storage_host_path }}"        # Mount this directory into the pod
            type: DirectoryOrCreate
---
# PV/PVC for Nextcloud (RWX to the NFS export)
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nextcloud-nfs-pv
spec:
  capacity:
    storage: 2Ti
  accessModes: ["ReadWriteMany"]
  persistentVolumeReclaimPolicy: Retain
  nfs:
    server: {{ storage_node_ip }}
    path: /exports                                # points to storage location on the pod that is managed by kubernetes (only useful for other pods)
  mountOptions:
    - nfsvers=4.2
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nextcloud-data
  namespace: {{ nextcloud_namespace }}
spec:
  accessModes: ["ReadWriteMany"]
  resources:
    requests:
      storage: 2Ti
  volumeName: nextcloud-nfs-pv
---
# Samba: re-exports the same storage over SMB for Windows/macOS
apiVersion: v1
kind: ConfigMap
metadata:
  name: samba-config
  namespace: {{ nextcloud_namespace }}
data:
  smb.conf: |
    [global]
      workgroup = WORKGROUP
      server string = Samba in RKE2
      security = user
      map to guest = Bad User
      smb encrypt = desired
      log file = /var/log/samba/log.%m
      max log size = 1000

    [NextcloudData]
      path = /data/share
      browseable = yes
      writable = yes
      guest ok = no
      create mask = 0664
      directory mask = 0775
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: samba
  namespace: {{ nextcloud_namespace }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: samba
  template:
    metadata:
      labels:
        app: samba
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      nodeSelector:
        kubernetes.io/hostname: {{ storage_node }}
      containers:
        - name: samba
          image: crazymax/samba:latest
          securityContext:
            runAsUser: 0
          env:
            - name: SAMBA_LOG_LEVEL
              value: "1"
          volumeMounts:
            - name: smb-conf
              mountPath: /etc/samba
            - name: data
              mountPath: /data/share
      volumes:
        - name: smb-conf
          configMap:
            name: samba-config
        - name: data
          nfs:
            server: {{ storage_node_ip }}
            path: /exports
